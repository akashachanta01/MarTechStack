{% extends "jobs/base.html" %}
{% block title %}Post a Job ‚Äî MarTechStack{% endblock %}

{% block content %}
<div class="bg-slate-50 min-h-screen py-12">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    
    <div class="text-center mb-10">
      <h1 class="text-3xl font-extrabold text-gray-900">Post a Role</h1>
      <p class="mt-2 text-gray-600">Reach the best Marketing Ops professionals.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
      
      <div class="lg:col-span-2">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
          <form method="post" enctype="multipart/form-data" class="space-y-6" id="job-form">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
              <div class="bg-red-50 text-red-600 p-4 rounded-xl text-sm mb-6">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <div>
              <h3 class="text-lg font-bold text-gray-900 border-b border-gray-100 pb-2 mb-4">The Basics</h3>
              <div class="grid grid-cols-1 gap-6">
                
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1">Job Title</label>
                  {{ form.title }}
                  {{ form.title.errors }}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1">Company Name</label>
                      {{ form.company }}
                    </div>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1">Company Logo</label>
                      {{ form.company_logo }}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-1">Location</label>
                     {{ form.location }}
                   </div>
                   <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-1">Salary Range</label>
                      {{ form.salary_range }}
                   </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Job Type</label>
                        {{ form.role_type }}
                    </div>
                    <div class="flex items-center gap-2 pt-6">
                        {{ form.remote }}
                        <label for="{{ form.remote.id_for_label }}" class="text-sm font-semibold text-gray-700 cursor-pointer">
                            This position is fully remote
                        </label>
                    </div>
                </div>

                <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 flex items-start gap-3 mt-2">
                    <input type="checkbox" id="feature-post" class="mt-1 rounded border-amber-400 text-amber-600 focus:ring-amber-500">
                    <div>
                        <label for="feature-post" class="block text-sm font-bold text-gray-900 cursor-pointer">
                            Highlight this post? (Example Feature)
                        </label>
                        <p class="text-xs text-gray-600">Adds a gold border and sticky status to your post.</p>
                    </div>
                </div>

              </div>
            </div>

            <div class="pt-6">
              <h3 class="text-lg font-bold text-gray-900 border-b border-gray-100 pb-2 mb-4">The Details</h3>
              
              <div class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Application Link</label>
                    {{ form.apply_url }}
                    <p class="text-xs text-gray-500 mt-1">Link to Greenhouse, Lever, or your career page.</p>
                </div>

                <div>
                   <label class="block text-sm font-semibold text-gray-700 mb-2">Tech Stack</label>
                   <div class="h-48 overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50 text-sm">
                       {{ form.tools }}
                   </div>
                   <p class="text-xs text-gray-500 mt-1">Select the tools this role uses.</p>
                </div>

                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-1">Job Description</label>
                  {{ form.description }}
                </div>
              </div>
            </div>

            <div class="pt-6">
              <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-md transition-all text-lg">
                Post Job for Review
              </button>
            </div>

          </form>
        </div>
      </div>

      <div class="hidden lg:block lg:col-span-1 sticky top-24">
         <div class="text-sm font-bold text-gray-400 uppercase tracking-wide mb-3">Live Preview</div>
         
         <div id="preview-card" class="bg-white border border-gray-200 rounded-2xl p-6 shadow-lg transition-all duration-300">
            <div class="flex items-start gap-4">
              
              <div class="flex-shrink-0 pt-1">
                 <img id="preview-logo-img" src="" alt="Logo" class="hidden w-14 h-14 rounded-xl object-contain border border-gray-100 bg-white p-1">
                 <div id="preview-logo-placeholder" class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-50 to-indigo-100 flex items-center justify-center text-xl font-bold text-gray-400 border border-gray-100 shadow-inner">
                    <span id="preview-logo-text">?</span>
                 </div>
              </div>

              <div class="flex-grow min-w-0">
                <h3 class="text-lg font-bold text-gray-900 leading-snug break-words" id="preview-title">
                  Senior Marketing Ops Manager
                </h3>
                
                <div class="text-sm font-medium text-gray-500 mt-1 mb-3">
                  <span id="preview-company">Company Name</span> 
                  <span class="text-gray-300 mx-1">‚Ä¢</span> 
                  <span id="preview-location">Location</span>
                </div>
                
                <div class="flex flex-wrap gap-2" id="preview-tags">
                    <span id="preview-remote-tag" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold bg-emerald-50 text-emerald-700 border border-emerald-100">
                        ‚óè Remote
                    </span>
                    <span id="preview-salary-tag" class="hidden inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold bg-slate-100 text-slate-700 border border-slate-200">
                        üí∞ <span id="preview-salary-text"></span>
                    </span>
                    </div>
              </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-50 flex justify-end">
                <button class="bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg shadow-sm text-sm opacity-50 cursor-not-allowed">
                    Apply now
                </button>
            </div>
         </div>

         <div class="mt-6 bg-blue-50 text-blue-800 p-4 rounded-xl text-sm">
            <strong>‚ú® Pro Tip:</strong> Detailed job descriptions with clear salary ranges get 2x more applicants.
         </div>

      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inputs
    const titleInput = document.getElementById('{{ form.title.id_for_label }}');
    const companyInput = document.getElementById('{{ form.company.id_for_label }}');
    const locationInput = document.getElementById('{{ form.location.id_for_label }}');
    const salaryInput = document.getElementById('{{ form.salary_range.id_for_label }}');
    const remoteInput = document.getElementById('{{ form.remote.id_for_label }}');
    const logoInput = document.getElementById('{{ form.company_logo.id_for_label }}');
    const featureCheckbox = document.getElementById('feature-post');
    const toolsInputs = document.querySelectorAll('input[name="tools"]');

    // Preview Elements
    const pTitle = document.getElementById('preview-title');
    const pCompany = document.getElementById('preview-company');
    const pLocation = document.getElementById('preview-location');
    const pSalaryTag = document.getElementById('preview-salary-tag');
    const pSalaryText = document.getElementById('preview-salary-text');
    const pRemoteTag = document.getElementById('preview-remote-tag');
    const pCard = document.getElementById('preview-card');
    
    // Logo Elements
    const pLogoImg = document.getElementById('preview-logo-img');
    const pLogoPlaceholder = document.getElementById('preview-logo-placeholder');
    const pLogoText = document.getElementById('preview-logo-text');

    // 1. Text Sync
    function updateText(input, element, fallback) {
        element.textContent = input.value || fallback;
    }

    if(titleInput) titleInput.addEventListener('input', () => updateText(titleInput, pTitle, 'Job Title'));
    
    if(companyInput) {
        companyInput.addEventListener('input', () => {
            updateText(companyInput, pCompany, 'Company');
            if(!logoInput.files.length) pLogoText.textContent = (companyInput.value[0] || '?').toUpperCase();
        });
    }
    
    if(locationInput) locationInput.addEventListener('input', () => updateText(locationInput, pLocation, 'Location'));

    // 2. Salary Tag Logic
    if(salaryInput) {
        salaryInput.addEventListener('input', () => {
            if (salaryInput.value) {
                pSalaryText.textContent = salaryInput.value;
                pSalaryTag.classList.remove('hidden');
            } else {
                pSalaryTag.classList.add('hidden');
            }
        });
    }

    // 3. Remote Tag Logic
    if(remoteInput) {
        remoteInput.addEventListener('change', () => {
            if (remoteInput.checked) {
                pRemoteTag.classList.remove('hidden');
            } else {
                pRemoteTag.classList.add('hidden');
            }
        });
    }

    // 4. Logo Preview (File Reader)
    if(logoInput) {
        logoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pLogoImg.src = e.target.result;
                    pLogoImg.classList.remove('hidden');
                    pLogoPlaceholder.classList.add('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                pLogoImg.classList.add('hidden');
                pLogoPlaceholder.classList.remove('hidden');
            }
        });
    }

    // 5. Highlight/Feature Toggle
    if(featureCheckbox) {
        featureCheckbox.addEventListener('change', () => {
            if(featureCheckbox.checked) {
                pCard.classList.add('border-amber-400', 'bg-amber-50');
                pCard.classList.remove('bg-white', 'border-gray-200');
            } else {
                pCard.classList.remove('border-amber-400', 'bg-amber-50');
                pCard.classList.add('bg-white', 'border-gray-200');
            }
        });
    }
    
    // 6. Tech Stack Pills (Checkboxes)
    const tagsContainer = document.getElementById('preview-tags');
    function updateTechStack() {
        // Remove existing dynamic tech tags (keep remote/salary)
        const existingPills = tagsContainer.querySelectorAll('.tech-pill');
        existingPills.forEach(el => el.remove());

        // Add checked ones
        let count = 0;
        toolsInputs.forEach(checkbox => {
            if(checkbox.checked && count < 4) { // Limit to 4 for preview
                const label = checkbox.parentElement.textContent.trim();
                const span = document.createElement('span');
                span.className = 'tech-pill inline-flex items-center px-3 py-1 rounded-md text-xs font-bold bg-purple-50 text-purple-700 border border-purple-100';
                span.textContent = label;
                tagsContainer.appendChild(span);
                count++;
            }
        });
    }

    // Attach listeners to all tool checkboxes
    if(toolsInputs) {
        toolsInputs.forEach(checkbox => {
            checkbox.addEventListener('change', updateTechStack);
        });
    }

});
</script>
{% endblock %}
